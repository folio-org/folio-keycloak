name: Keycloak Upgrade Gate

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]
    paths:
      - 'Dockerfile'
      - 'Dockerfile-fips'

jobs:
  keycloak-upgrade-gate:
    # Only run for Dependabot PRs that modify Keycloak-related files
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Check if PR updates Keycloak version
        id: check-keycloak
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const keycloakUpdate = files.some(file =>
              (file.filename === 'Dockerfile' || file.filename === 'Dockerfile-fips') &&
              file.patch && file.patch.includes('quay.io/keycloak/keycloak')
            );

            console.log(`Keycloak version update detected: ${keycloakUpdate}`);
            core.setOutput('is_keycloak_update', keycloakUpdate);

      - name: Verify keycloak-verified label is present
        if: steps.check-keycloak.outputs.is_keycloak_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const labels = pullRequest.labels.map(label => label.name);
            const hasVerifiedLabel = labels.includes('keycloak-verified');

            console.log(`PR labels: ${labels.join(', ')}`);
            console.log(`Has keycloak-verified label: ${hasVerifiedLabel}`);

            if (!hasVerifiedLabel) {
              core.setFailed(
                '❌ This Keycloak upgrade PR requires manual verification.\n\n' +
                'Please complete all steps in the runbook comment and then add the ' +
                '`keycloak-verified` label to this PR.\n\n' +
                'See the PR comment for detailed instructions.'
              );
            } else {
              console.log('✅ PR has keycloak-verified label. Gate check passed.');
            }

      - name: Non-Keycloak update detected
        if: steps.check-keycloak.outputs.is_keycloak_update != 'true'
        run: |
          echo "This Dependabot PR does not update Keycloak version. Skipping gate check."
